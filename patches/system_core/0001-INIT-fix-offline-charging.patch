From 2ead9a273778d2778db5eb75168f2461aec5da24 Mon Sep 17 00:00:00 2001
From: olegsvs <oleg.texet@gmail.com>
Date: Thu, 21 Jul 2016 04:49:42 -0400
Subject: [PATCH] INIT: fix offline charging

Change-Id: Ie318bc505374abce5f947c8716dfa22996944c27
---
 0001-libgui-healhd-fix.patch | 102 +++++++++++++++++++++++++++++++++++++++++++
 init/Android.mk              |   3 +-
 init/init.cpp                |  10 ++++-
 3 files changed, 113 insertions(+), 2 deletions(-)
 create mode 100644 0001-libgui-healhd-fix.patch

diff --git a/0001-libgui-healhd-fix.patch b/0001-libgui-healhd-fix.patch
new file mode 100644
index 0000000..4401976
--- /dev/null
+++ b/0001-libgui-healhd-fix.patch
@@ -0,0 +1,102 @@
+From dbf0f518f7066228d4f7bda39e7e7d5b363a1c60 Mon Sep 17 00:00:00 2001
+From: olegsvs <oleg.texet@gmail.com>
+Date: Thu, 21 Jul 2016 04:25:16 -0400
+Subject: [PATCH] libgui && healhd fix
+
+Change-Id: I8c2504300c18b3a3fdd8c2f1fd430ebe8584e0d1
+---
+ 0001-patch-for-6735m.patch | 39 +++++++++++++++++++++++++++++++++++++++
+ healthd/BatteryMonitor.cpp |  4 ++--
+ libutils/Android.mk        |  4 ++++
+ libutils/MediatekHacks.cpp |  3 +++
+ 4 files changed, 48 insertions(+), 2 deletions(-)
+ create mode 100644 0001-patch-for-6735m.patch
+ create mode 100644 libutils/MediatekHacks.cpp
+
+diff --git a/0001-patch-for-6735m.patch b/0001-patch-for-6735m.patch
+new file mode 100644
+index 0000000..d1df5eb
+--- /dev/null
++++ b/0001-patch-for-6735m.patch
+@@ -0,0 +1,39 @@
++From 14830ceb62e649a8eda09cb99066be12fd0fad21 Mon Sep 17 00:00:00 2001
++From: olegsvs <oleg.texet@gmail.com>
++Date: Sat, 9 Jul 2016 10:18:58 -0900
++Subject: [PATCH] patch for 6735m
++
++Change-Id: Ia009ecbec0a4e6a43e5fe2b4edce2eefd592ee2d
++---
++ libutils/Android.mk        | 4 ++++
++ libutils/MediatekHacks.cpp | 3 +++
++ 2 files changed, 7 insertions(+)
++ create mode 100644 libutils/MediatekHacks.cpp
++
++diff --git a/libutils/Android.mk b/libutils/Android.mk
++index 23a5c59..0a31370 100644
++--- a/libutils/Android.mk
+++++ b/libutils/Android.mk
++@@ -83,6 +83,10 @@ LOCAL_CFLAGS += -DALIGN_DOUBLE
++ endif
++ LOCAL_CFLAGS += -Werror
++ 
+++ifeq ($(BOARD_HAS_MTK_HARDWARE), true)
+++LOCAL_SRC_FILES += MediatekHacks.cpp
+++endif
+++
++ LOCAL_STATIC_LIBRARIES := \
++ 	libcutils \
++ 	libc
++diff --git a/libutils/MediatekHacks.cpp b/libutils/MediatekHacks.cpp
++new file mode 100644
++index 0000000..33a10ec
++--- /dev/null
+++++ b/libutils/MediatekHacks.cpp
++@@ -0,0 +1,3 @@
+++extern "C" {
+++ void _ZN7android11IDumpTunnel11asInterfaceERKNS_2spINS_7IBinderEEE(){}
+++}
++-- 
++1.9.1
++
+diff --git a/healthd/BatteryMonitor.cpp b/healthd/BatteryMonitor.cpp
+index a59c779..110e942 100644
+--- a/healthd/BatteryMonitor.cpp
++++ b/healthd/BatteryMonitor.cpp
+@@ -206,8 +206,8 @@ bool BatteryMonitor::update(void) {
+     props.batteryLevel = mBatteryFixedCapacity ?
+         mBatteryFixedCapacity :
+         getIntField(mHealthdConfig->batteryCapacityPath);
+-    props.batteryVoltage = getIntField(mHealthdConfig->batteryVoltagePath) / 1000;
+-
++    //props.batteryVoltage = getIntField(mHealthdConfig->batteryVoltagePath) / 1000;
++	props.batteryVoltage = getIntField(mHealthdConfig->batteryVoltagePath); // mt6735
+     props.batteryTemperature = mBatteryFixedTemperature ?
+         mBatteryFixedTemperature :
+         getIntField(mHealthdConfig->batteryTemperaturePath);
+diff --git a/libutils/Android.mk b/libutils/Android.mk
+index 23a5c59..0a31370 100644
+--- a/libutils/Android.mk
++++ b/libutils/Android.mk
+@@ -83,6 +83,10 @@ LOCAL_CFLAGS += -DALIGN_DOUBLE
+ endif
+ LOCAL_CFLAGS += -Werror
+ 
++ifeq ($(BOARD_HAS_MTK_HARDWARE), true)
++LOCAL_SRC_FILES += MediatekHacks.cpp
++endif
++
+ LOCAL_STATIC_LIBRARIES := \
+ 	libcutils \
+ 	libc
+diff --git a/libutils/MediatekHacks.cpp b/libutils/MediatekHacks.cpp
+new file mode 100644
+index 0000000..33a10ec
+--- /dev/null
++++ b/libutils/MediatekHacks.cpp
+@@ -0,0 +1,3 @@
++extern "C" {
++ void _ZN7android11IDumpTunnel11asInterfaceERKNS_2spINS_7IBinderEEE(){}
++}
+-- 
+1.9.1
+
diff --git a/init/Android.mk b/init/Android.mk
index 85dfbfc..41a02a3 100644
--- a/init/Android.mk
+++ b/init/Android.mk
@@ -71,8 +71,9 @@ endif
 ifneq ($(TARGET_INIT_UMOUNT_AND_FSCK_IS_UNSAFE),)
 LOCAL_CFLAGS += -DUMOUNT_AND_FSCK_IS_UNSAFE
 endif
-
+LOCAL_CFLAGS += -DMTK_MT6735
 LOCAL_MODULE:= init
+
 LOCAL_C_INCLUDES += \
     external/zlib \
     system/extras/ext4_utils \
diff --git a/init/init.cpp b/init/init.cpp
index 58d7d34..b483c7c 100644
--- a/init/init.cpp
+++ b/init/init.cpp
@@ -818,6 +818,10 @@ static void export_kernel_boot_props() {
         { "ro.boot.baseband",   "ro.baseband",   "unknown", },
         { "ro.boot.bootloader", "ro.bootloader", "unknown", },
         { "ro.boot.hardware",   "ro.hardware",   "unknown", },
+
+
+        { "ro.boot.hardware",   "ro.hardware",   "mt6735", },
+
 #ifndef IGNORE_RO_BOOT_REVISION
         { "ro.boot.revision",   "ro.revision",   "0", },
 #endif
@@ -929,6 +933,9 @@ static bool selinux_is_disabled(void)
 
 static bool selinux_is_enforcing(void)
 {
+
+	return false; 
+
     if (ALLOW_DISABLE_SELINUX) {
         return selinux_status_from_cmdline() == SELINUX_ENFORCING;
     }
@@ -1016,7 +1023,7 @@ static int charging_mode_booting(void) {
         return 0;
 
     close(f);
-    return ('1' == cmb);
+    return ('8' == cmb);
 #endif
 }
 
@@ -1175,3 +1182,4 @@ int main(int argc, char** argv) {
 
     return 0;
 }
+
-- 
1.9.1

